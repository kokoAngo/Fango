<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ã¾ã„æ¤œç´¢ - Housing Finder</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .content { padding: 40px; }

        .form-section { margin-bottom: 30px; }
        .form-section label { display: block; color: #667eea; margin-bottom: 10px; font-weight: bold; font-size: 1.1em; }
        .form-section .required { color: #e74c3c; }
        .form-section .optional { color: #888; font-weight: normal; font-size: 0.9em; }

        .mbti-select {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .mbti-select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .mbti-select:hover { border-color: #667eea; }

        .user-input {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            resize: vertical;
            min-height: 150px;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        .user-input:focus { outline: none; border-color: #764ba2; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3); }
        .user-input::placeholder { color: #aaa; }
        .agent-notes { border-color: #27ae60; min-height: 120px; }
        .agent-notes:focus { border-color: #1e8449; box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2); }

        .hint { font-size: 0.85em; color: #888; margin-top: 8px; line-height: 1.6; }

        .search-button {
            display: block;
            width: 100%;
            padding: 18px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            margin-top: 20px;
        }
        .search-button:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5); }
        .search-button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }

        .loading { display: none; text-align: center; padding: 30px; }
        .loading.active { display: block; }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
        }
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: progressMove 1.5s ease-in-out infinite;
            border-radius: 3px;
        }
        @keyframes progressMove {
            0% { background-position: 100% 0; width: 30%; margin-left: 0; }
            50% { width: 50%; }
            100% { background-position: 0 0; width: 30%; margin-left: 70%; }
        }

        /* æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ */
        .log-container {
            width: 100%;
            max-width: 400px;
            height: 140px;
            margin: 15px auto 0;
            overflow: hidden;
            position: relative;
        }
        .log-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, white 0%, transparent 100%);
            z-index: 1;
            pointer-events: none;
        }
        .log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 100%;
        }
        .log-item {
            padding: 6px 12px;
            font-size: 0.9em;
            color: #666;
            text-align: left;
            animation: logSlideIn 0.3s ease-out;
            opacity: 1;
            transition: opacity 0.3s;
        }
        .log-item:nth-last-child(1) { color: #667eea; font-weight: 500; }
        .log-item:nth-last-child(2) { opacity: 0.85; }
        .log-item:nth-last-child(3) { opacity: 0.7; }
        .log-item:nth-last-child(4) { opacity: 0.5; }
        .log-item:nth-last-child(5) { opacity: 0.3; }
        .log-item.fading { opacity: 0; transform: translateY(-10px); }

        @keyframes logSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-title {
            color: #667eea;
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .error { background: #fee; color: #c33; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .error.active { display: block; }

        /* æœç´¢åŒºåŸŸæ˜¾ç¤ºæ¡†æ ·å¼ */
        .search-areas-panel {
            display: none;
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .search-areas-panel.active { display: block; }
        .search-areas-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .search-areas-panel h3::before { content: "ğŸ”"; }

        .areas-section { margin-bottom: 15px; }
        .areas-section:last-child { margin-bottom: 0; }
        .areas-section-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .areas-section-title.location::before { content: "ğŸ“ "; }
        .areas-section-title.line::before { content: "ğŸšƒ "; }

        .area-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .area-tag {
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.9em;
            color: #333;
            transition: all 0.2s;
        }
        .area-tag.location { border-color: #667eea; color: #667eea; }
        .area-tag.line { border-color: #27ae60; color: #27ae60; }
        .area-tag:hover { transform: scale(1.05); }

        .hierarchy-info {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }
        .hierarchy-info span { color: #667eea; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä½ã¾ã„æ¤œç´¢</h1>
            <p>ã‚ãªãŸã®å¸Œæœ›æ¡ä»¶ã§ç‰©ä»¶ã‚’æ¤œç´¢</p>
        </div>
        <div class="content">
            <div class="error" id="error"></div>

            <div class="form-section">
                <label for="userRequirements">
                    å¸Œæœ›æ¡ä»¶ã‚’å…¥åŠ› <span class="required">*å¿…é ˆ</span>
                </label>
                <textarea class="user-input" id="userRequirements" placeholder="ä¾‹ï¼š
ãƒ»æ±äº¬éƒ½ æ¸‹è°·åŒº
ãƒ»é§…ã‹ã‚‰å¾’æ­©10åˆ†ä»¥å†…
ãƒ»è³ƒæ–™10ä¸‡å††ä»¥å†…
ãƒ»2LDK
ãƒ»å—å‘ã
ãƒ»ãƒšãƒƒãƒˆå¯"></textarea>
                <p class="hint">
                    <strong>å…¥åŠ›ã§ãã‚‹æ¡ä»¶ï¼š</strong>åœ°åŸŸï¼ˆæ±äº¬ã€æ¸‹è°·åŒºãªã©ï¼‰ã€è³ƒæ–™ï¼ˆ10ä¸‡å††ä»¥å†…ã€8ï½12ä¸‡ãªã©ï¼‰ã€<br>
                    é–“å–ã‚Šï¼ˆãƒ¯ãƒ³ãƒ«ãƒ¼ãƒ ã€1Kã€2LDKç­‰ï¼‰ã€é§…ãƒ»å¾’æ­©åˆ†æ•°ã€å‘ãï¼ˆå—å‘ãç­‰ï¼‰ã€<br>
                    ãã®ä»–ï¼ˆæ–°ç¯‰ã€ãƒšãƒƒãƒˆå¯ã€è§’éƒ¨å±‹ã€ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ç­‰ï¼‰
                </p>
            </div>

            <div class="form-section">
                <label for="agentNotes">
                    æ‹…å½“è€…ã‚³ãƒ¡ãƒ³ãƒˆ <span class="optional">ï¼ˆä»»æ„ï¼‰</span>
                </label>
                <textarea class="user-input agent-notes" id="agentNotes" placeholder="ä¾‹ï¼š
ãƒ»ãŠå®¢æ§˜ã¯é™ã‹ãªç’°å¢ƒã‚’å¸Œæœ›ã•ã‚Œã¦ã„ã¾ã™
ãƒ»é§…ã‹ã‚‰å°‘ã—é ãã¦ã‚‚åºƒã•ã‚’é‡è¦–
ãƒ»äºˆç®—ã«ä½™è£•ãŒã‚ã‚Œã°æ–°ç¯‰ã‚‚æ¤œè¨å¯
ãƒ»ãƒšãƒƒãƒˆã¯å°å‹çŠ¬1åŒ¹
ãƒ»åœ¨å®…å‹¤å‹™ãŒå¤šã„ãŸã‚æ—¥å½“ãŸã‚Šé‡è¦–"></textarea>
                <p class="hint">
                    <strong>æ‹…å½“è€…ã®è¦–ç‚¹ï¼š</strong>ãŠå®¢æ§˜ã¨ã®ä¼šè©±ã§å¾—ãŸæƒ…å ±ã‚„ã€æ¡ä»¶ã®å„ªå…ˆåº¦ã€
                    ç‰¹è¨˜äº‹é …ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIãŒã‚ˆã‚Šé©åˆ‡ãªæ¤œç´¢æ¡ä»¶ã‚’ææ¡ˆã—ã¾ã™ã€‚
                </p>
            </div>

            <div class="form-section">
                <label for="mbtiSelect">
                    ä½ã¾ã„MBTIã‚¿ã‚¤ãƒ— <span class="optional">ï¼ˆä»»æ„ï¼‰</span>
                </label>
                <select class="mbti-select" id="mbtiSelect">
                    <option value="">-- é¸æŠã—ãªã„ --</option>
                </select>
            </div>

            <button class="search-button" id="searchButton" disabled>ç‰©ä»¶ã‚’æ¤œç´¢ã™ã‚‹</button>

            <!-- æœç´¢åŒºåŸŸæ˜¾ç¤ºé¢æ¿ -->
            <div class="search-areas-panel" id="searchAreasPanel">
                <h3>æ¤œç´¢å¯¾è±¡ã‚¨ãƒªã‚¢</h3>
                <div class="hierarchy-info" id="hierarchyInfo"></div>
                <div class="areas-section" id="locationSection">
                    <div class="areas-section-title location">æ‰€åœ¨åœ°</div>
                    <div class="area-tags" id="locationTags"></div>
                </div>
                <div class="areas-section" id="lineSection">
                    <div class="areas-section-title line">æ²¿ç·šãƒ»é§…</div>
                    <div class="area-tags" id="lineTags"></div>
                </div>
            </div>

            <div class="loading" id="loading">
                <p class="loading-title">ç‰©ä»¶ã‚’æ¤œç´¢ä¸­...</p>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-bar-inner"></div>
                    </div>
                </div>
                <div class="log-container">
                    <ul class="log-list" id="logList"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mbtiTypes = [];

        async function loadMBTITypes() {
            try {
                const response = await fetch('/api/mbti-types');
                mbtiTypes = await response.json();
                renderMBTISelect();
            } catch (error) {
                console.error('Failed to load MBTI types');
            }
        }

        function renderMBTISelect() {
            const select = document.getElementById('mbtiSelect');
            mbtiTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.type_id;
                option.textContent = type.display_name_ja + ' (' + type.type_id + ')';
                select.appendChild(option);
            });
        }

        // æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦æœ‰å†…å®¹
        function updateSearchButton() {
            const userInput = document.getElementById('userRequirements').value.trim();
            document.getElementById('searchButton').disabled = !userInput;
        }

        document.getElementById('userRequirements').addEventListener('input', updateSearchButton);

        document.getElementById('searchButton').addEventListener('click', async () => {
            const userRequirements = document.getElementById('userRequirements').value.trim();
            const agentNotes = document.getElementById('agentNotes').value.trim();

            if (!userRequirements) {
                showError('å¸Œæœ›æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            hideError();
            showLoading();

            try {
                const typeId = document.getElementById('mbtiSelect').value || null;

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        typeId: typeId,
                        userRequirements: userRequirements,
                        agentNotes: agentNotes
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // æ˜¾ç¤ºæœç´¢åŒºåŸŸä¿¡æ¯
                if (data.parsed_requirements) {
                    showSearchAreas(data.parsed_requirements, data.searched_locations);
                }

                localStorage.setItem('searchResults', JSON.stringify(data));
                localStorage.setItem('userRequirements', userRequirements);

                // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æœç´¢åŒºåŸŸ
                setTimeout(() => {
                    window.location.href = '/results.html';
                }, 1500);
            } catch (error) {
                showError(error.message);
                hideLoading();
            }
        });

        // æ—¥å¿—ç®¡ç†
        let logMessages = [];
        let logInterval = null;
        const MAX_LOGS = 5;

        const searchLogSequence = [
            'AIè§£æã‚’é–‹å§‹...',
            'å…¥åŠ›æ¡ä»¶ã‚’åˆ†æä¸­...',
            'ä½ç½®æƒ…å ±ã‚’ç‰¹å®šä¸­...',
            'æ¤œç´¢æ¡ä»¶ã‚’æœ€é©åŒ–ä¸­...',
            'REINSã«æ¥ç¶šä¸­...',
            'ãƒ–ãƒ©ã‚¦ã‚¶ã‚’èµ·å‹•ä¸­...',
            'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...',
            'æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¨­å®šä¸­...',
            'åœ°åŸŸã‚’é¸æŠä¸­...',
            'è³ƒæ–™æ¡ä»¶ã‚’è¨­å®šä¸­...',
            'é–“å–ã‚Šã‚’é¸æŠä¸­...',
            'æ¤œç´¢ã‚’å®Ÿè¡Œä¸­...',
            'ç‰©ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...',
            'çµæœã‚’æ•´ç†ä¸­...',
            'PDFã‚’ç”Ÿæˆä¸­...',
            'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ä¸­...',
            'å®Œäº†ã¾ã§ã‚ã¨å°‘ã—...'
        ];

        function addLog(message) {
            const logList = document.getElementById('logList');
            if (!logList) return;

            const li = document.createElement('li');
            li.className = 'log-item';
            li.textContent = 'â†’ ' + message;
            logList.appendChild(li);

            logMessages.push(message);

            // è¶…è¿‡5æ¡æ—¶ï¼Œç§»é™¤æœ€æ—§çš„ï¼ˆå¸¦æ·¡å‡ºæ•ˆæœï¼‰
            if (logList.children.length > MAX_LOGS) {
                const firstItem = logList.firstChild;
                if (firstItem && !firstItem.classList.contains('fading')) {
                    firstItem.classList.add('fading');
                    setTimeout(() => {
                        if (firstItem.parentNode) {
                            firstItem.remove();
                        }
                    }, 300);
                    logMessages.shift();
                }
            }
        }

        function clearLogs() {
            const logList = document.getElementById('logList');
            if (logList) {
                logList.innerHTML = '';
            }
            logMessages = [];
        }

        function startLogSequence() {
            let index = 0;
            clearLogs();
            addLog(searchLogSequence[0]);
            index++;

            logInterval = setInterval(() => {
                if (index < searchLogSequence.length) {
                    addLog(searchLogSequence[index]);
                    index++;
                } else {
                    // å¾ªç¯æœ€åå‡ æ¡
                    const loopMessages = ['å‡¦ç†ä¸­...', 'ã‚‚ã†å°‘ã—ãŠå¾…ã¡ãã ã•ã„...', 'ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...'];
                    addLog(loopMessages[index % loopMessages.length]);
                    index++;
                }
            }, 2000);
        }

        function stopLogSequence() {
            if (logInterval) {
                clearInterval(logInterval);
                logInterval = null;
            }
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('searchButton').disabled = true;
            startLogSequence();
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
            stopLogSequence();
            updateSearchButton();
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        function hideError() {
            document.getElementById('error').classList.remove('active');
        }

        // æ˜¾ç¤ºæœç´¢åŒºåŸŸ
        function showSearchAreas(data, searchedLocations) {
            const panel = document.getElementById('searchAreasPanel');
            const hierarchyInfo = document.getElementById('hierarchyInfo');
            const locationTags = document.getElementById('locationTags');
            const lineTags = document.getElementById('lineTags');
            const locationSection = document.getElementById('locationSection');
            const lineSection = document.getElementById('lineSection');

            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            hierarchyInfo.innerHTML = '';
            locationTags.innerHTML = '';
            lineTags.innerHTML = '';

            // ä¼˜å…ˆä½¿ç”¨ searchedLocationsï¼ˆå®é™…æœç´¢çš„åœ°ç‚¹ï¼‰
            if (searchedLocations && searchedLocations.length > 0) {
                // åˆ¤æ–­æ˜¯æ²¿ç·šæœç´¢è¿˜æ˜¯æ‰€åœ¨åœ°æœç´¢
                const isLineSearch = searchedLocations.some(loc => loc.line || loc.station);
                const isLocationSearch = searchedLocations.some(loc => loc.city || loc.town);

                if (isLineSearch) {
                    // æ²¿ç·šæœç´¢ç»“æœ
                    const lines = [...new Set(searchedLocations.map(loc => loc.line).filter(Boolean))];
                    const stations = [...new Set(searchedLocations.map(loc => loc.station).filter(Boolean))];

                    if (lines.length > 0) {
                        hierarchyInfo.innerHTML = `<span>ğŸšƒ ${lines.join('ã€')}</span>`;
                    }

                    lineSection.style.display = 'block';
                    locationSection.style.display = 'none';
                    searchedLocations.forEach(loc => {
                        if (loc.line || loc.station) {
                            const tag = document.createElement('span');
                            tag.className = 'area-tag line';
                            const stationInfo = loc.station ? `${loc.station}é§…` : '';
                            const lineInfo = loc.line ? `(${loc.line})` : '';
                            tag.textContent = `${stationInfo} ${lineInfo}`.trim();
                            lineTags.appendChild(tag);
                        }
                    });
                } else if (isLocationSearch) {
                    // æ‰€åœ¨åœ°æœç´¢ç»“æœ
                    const prefectures = [...new Set(searchedLocations.map(loc => loc.prefecture).filter(Boolean))];
                    const cities = [...new Set(searchedLocations.map(loc => loc.city).filter(Boolean))];

                    if (prefectures.length > 0) {
                        hierarchyInfo.innerHTML = `<span>${prefectures.join('ã€')}</span> â†’ <span>${cities.join('ã€')}</span>`;
                    }

                    locationSection.style.display = 'block';
                    lineSection.style.display = 'none';
                    searchedLocations.forEach(loc => {
                        if (loc.city) {
                            const tag = document.createElement('span');
                            tag.className = 'area-tag location';
                            const townInfo = loc.town ? ` ${loc.town}` : '';
                            tag.textContent = `${loc.city}${townInfo}`.trim();
                            locationTags.appendChild(tag);
                        }
                    });
                }

                panel.classList.add('active');
                return;
            }

            // ä½¿ç”¨ searchOptions
            if (!data || !data.searchOptions || data.searchOptions.length === 0) {
                panel.classList.remove('active');
                return;
            }

            // æ˜¾ç¤ºå±‚æ¬¡ä¿¡æ¯
            if (data.hierarchyAnalysis) {
                const h = data.hierarchyAnalysis;
                hierarchyInfo.innerHTML = `
                    <span>${h.prefecture || ''}</span> â†’
                    <span>${h.mainCity || ''}</span>
                    ${h.nearbyDistricts && h.nearbyDistricts.length > 0 ?
                        ' ï¼ˆå‘¨è¾º: ' + h.nearbyDistricts.join('ã€') + 'ï¼‰' : ''}
                `;
            } else if (data.locations && data.locations.length > 0) {
                const loc = data.locations[0];
                hierarchyInfo.innerHTML = `<span>${loc.prefecture || ''}</span> â†’ <span>${loc.city || ''}</span>`;
            }

            // åˆ†ç±»æœç´¢é€‰é¡¹
            const locations = data.searchOptions.filter(opt => opt.searchMethod === 'location');
            const lines = data.searchOptions.filter(opt => opt.searchMethod === 'line');

            // æ˜¾ç¤ºæ‰€åœ¨åœ°
            if (locations.length > 0) {
                locationSection.style.display = 'block';
                locations.forEach(loc => {
                    const tag = document.createElement('span');
                    tag.className = 'area-tag location';
                    tag.textContent = `${loc.city} ${loc.town || ''}`.trim();
                    locationTags.appendChild(tag);
                });
            } else {
                locationSection.style.display = 'none';
            }

            // æ˜¾ç¤ºæ²¿çº¿
            if (lines.length > 0) {
                lineSection.style.display = 'block';
                lines.forEach(line => {
                    const tag = document.createElement('span');
                    tag.className = 'area-tag line';
                    tag.textContent = `${line.line} ${line.station}`;
                    lineTags.appendChild(tag);
                });
            } else {
                lineSection.style.display = 'none';
            }

            panel.classList.add('active');
        }

        // éšè—æœç´¢åŒºåŸŸ
        function hideSearchAreas() {
            document.getElementById('searchAreasPanel').classList.remove('active');
        }

        loadMBTITypes();
    </script>
</body>
</html>