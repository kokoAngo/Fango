<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ã¾ã„æ¤œç´¢ - Housing Finder</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .content { padding: 40px; }

        .form-section { margin-bottom: 30px; }
        .form-section label { display: block; color: #667eea; margin-bottom: 10px; font-weight: bold; font-size: 1.1em; }
        .form-section .required { color: #e74c3c; }
        .form-section .optional { color: #888; font-weight: normal; font-size: 0.9em; }

        .mbti-select {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .mbti-select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); }
        .mbti-select:hover { border-color: #667eea; }

        .user-input {
            width: 100%;
            padding: 15px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            resize: vertical;
            min-height: 150px;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        .user-input:focus { outline: none; border-color: #764ba2; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3); }
        .user-input::placeholder { color: #aaa; }
        .agent-notes { border-color: #27ae60; min-height: 120px; }
        .agent-notes:focus { border-color: #1e8449; box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2); }

        .hint { font-size: 0.85em; color: #888; margin-top: 8px; line-height: 1.6; }

        .search-button {
            display: block;
            width: 100%;
            padding: 18px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            margin-top: 20px;
        }
        .search-button:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5); }
        .search-button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }

        .loading { display: none; text-align: center; padding: 40px; }
        .loading.active { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error { background: #fee; color: #c33; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .error.active { display: block; }

        /* æœç´¢åŒºåŸŸæ˜¾ç¤ºæ¡†æ ·å¼ */
        .search-areas-panel {
            display: none;
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .search-areas-panel.active { display: block; }
        .search-areas-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .search-areas-panel h3::before { content: "ğŸ”"; }

        .areas-section { margin-bottom: 15px; }
        .areas-section:last-child { margin-bottom: 0; }
        .areas-section-title {
            font-weight: bold;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .areas-section-title.location::before { content: "ğŸ“ "; }
        .areas-section-title.line::before { content: "ğŸšƒ "; }

        .area-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .area-tag {
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.9em;
            color: #333;
            transition: all 0.2s;
        }
        .area-tag.location { border-color: #667eea; color: #667eea; }
        .area-tag.line { border-color: #27ae60; color: #27ae60; }
        .area-tag:hover { transform: scale(1.05); }

        .hierarchy-info {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }
        .hierarchy-info span { color: #667eea; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ä½ã¾ã„æ¤œç´¢</h1>
            <p>ã‚ãªãŸã®å¸Œæœ›æ¡ä»¶ã§ç‰©ä»¶ã‚’æ¤œç´¢</p>
        </div>
        <div class="content">
            <div class="error" id="error"></div>

            <div class="form-section">
                <label for="userRequirements">
                    å¸Œæœ›æ¡ä»¶ã‚’å…¥åŠ› <span class="required">*å¿…é ˆ</span>
                </label>
                <textarea class="user-input" id="userRequirements" placeholder="ä¾‹ï¼š
ãƒ»æ±äº¬éƒ½ æ¸‹è°·åŒº
ãƒ»é§…ã‹ã‚‰å¾’æ­©10åˆ†ä»¥å†…
ãƒ»è³ƒæ–™10ä¸‡å††ä»¥å†…
ãƒ»2LDK
ãƒ»å—å‘ã
ãƒ»ãƒšãƒƒãƒˆå¯"></textarea>
                <p class="hint">
                    <strong>å…¥åŠ›ã§ãã‚‹æ¡ä»¶ï¼š</strong>åœ°åŸŸï¼ˆæ±äº¬ã€æ¸‹è°·åŒºãªã©ï¼‰ã€è³ƒæ–™ï¼ˆ10ä¸‡å††ä»¥å†…ã€8ï½12ä¸‡ãªã©ï¼‰ã€<br>
                    é–“å–ã‚Šï¼ˆãƒ¯ãƒ³ãƒ«ãƒ¼ãƒ ã€1Kã€2LDKç­‰ï¼‰ã€é§…ãƒ»å¾’æ­©åˆ†æ•°ã€å‘ãï¼ˆå—å‘ãç­‰ï¼‰ã€<br>
                    ãã®ä»–ï¼ˆæ–°ç¯‰ã€ãƒšãƒƒãƒˆå¯ã€è§’éƒ¨å±‹ã€ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ç­‰ï¼‰
                </p>
            </div>

            <div class="form-section">
                <label for="agentNotes">
                    æ‹…å½“è€…ã‚³ãƒ¡ãƒ³ãƒˆ <span class="optional">ï¼ˆä»»æ„ï¼‰</span>
                </label>
                <textarea class="user-input agent-notes" id="agentNotes" placeholder="ä¾‹ï¼š
ãƒ»ãŠå®¢æ§˜ã¯é™ã‹ãªç’°å¢ƒã‚’å¸Œæœ›ã•ã‚Œã¦ã„ã¾ã™
ãƒ»é§…ã‹ã‚‰å°‘ã—é ãã¦ã‚‚åºƒã•ã‚’é‡è¦–
ãƒ»äºˆç®—ã«ä½™è£•ãŒã‚ã‚Œã°æ–°ç¯‰ã‚‚æ¤œè¨å¯
ãƒ»ãƒšãƒƒãƒˆã¯å°å‹çŠ¬1åŒ¹
ãƒ»åœ¨å®…å‹¤å‹™ãŒå¤šã„ãŸã‚æ—¥å½“ãŸã‚Šé‡è¦–"></textarea>
                <p class="hint">
                    <strong>æ‹…å½“è€…ã®è¦–ç‚¹ï¼š</strong>ãŠå®¢æ§˜ã¨ã®ä¼šè©±ã§å¾—ãŸæƒ…å ±ã‚„ã€æ¡ä»¶ã®å„ªå…ˆåº¦ã€
                    ç‰¹è¨˜äº‹é …ãªã©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIãŒã‚ˆã‚Šé©åˆ‡ãªæ¤œç´¢æ¡ä»¶ã‚’ææ¡ˆã—ã¾ã™ã€‚
                </p>
            </div>

            <div class="form-section">
                <label for="mbtiSelect">
                    ä½ã¾ã„MBTIã‚¿ã‚¤ãƒ— <span class="optional">ï¼ˆä»»æ„ï¼‰</span>
                </label>
                <select class="mbti-select" id="mbtiSelect">
                    <option value="">-- é¸æŠã—ãªã„ --</option>
                </select>
            </div>

            <button class="search-button" id="searchButton" disabled>ç‰©ä»¶ã‚’æ¤œç´¢ã™ã‚‹</button>

            <!-- æœç´¢åŒºåŸŸæ˜¾ç¤ºé¢æ¿ -->
            <div class="search-areas-panel" id="searchAreasPanel">
                <h3>æ¤œç´¢å¯¾è±¡ã‚¨ãƒªã‚¢</h3>
                <div class="hierarchy-info" id="hierarchyInfo"></div>
                <div class="areas-section" id="locationSection">
                    <div class="areas-section-title location">æ‰€åœ¨åœ°</div>
                    <div class="area-tags" id="locationTags"></div>
                </div>
                <div class="areas-section" id="lineSection">
                    <div class="areas-section-title line">æ²¿ç·šãƒ»é§…</div>
                    <div class="area-tags" id="lineTags"></div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>ç‰©ä»¶ã‚’æ¤œç´¢ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        let mbtiTypes = [];

        async function loadMBTITypes() {
            try {
                const response = await fetch('/api/mbti-types');
                mbtiTypes = await response.json();
                renderMBTISelect();
            } catch (error) {
                console.error('Failed to load MBTI types');
            }
        }

        function renderMBTISelect() {
            const select = document.getElementById('mbtiSelect');
            mbtiTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.type_id;
                option.textContent = type.display_name_ja + ' (' + type.type_id + ')';
                select.appendChild(option);
            });
        }

        // æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦æœ‰å†…å®¹
        function updateSearchButton() {
            const userInput = document.getElementById('userRequirements').value.trim();
            document.getElementById('searchButton').disabled = !userInput;
        }

        document.getElementById('userRequirements').addEventListener('input', updateSearchButton);

        document.getElementById('searchButton').addEventListener('click', async () => {
            const userRequirements = document.getElementById('userRequirements').value.trim();
            const agentNotes = document.getElementById('agentNotes').value.trim();

            if (!userRequirements) {
                showError('å¸Œæœ›æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            hideError();
            showLoading();

            try {
                const typeId = document.getElementById('mbtiSelect').value || null;

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        typeId: typeId,
                        userRequirements: userRequirements,
                        agentNotes: agentNotes
                    })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // æ˜¾ç¤ºæœç´¢åŒºåŸŸä¿¡æ¯
                if (data.parsed_requirements) {
                    showSearchAreas(data.parsed_requirements, data.searched_locations);
                }

                localStorage.setItem('searchResults', JSON.stringify(data));
                localStorage.setItem('userRequirements', userRequirements);

                // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æœç´¢åŒºåŸŸ
                setTimeout(() => {
                    window.location.href = '/results.html';
                }, 1500);
            } catch (error) {
                showError(error.message);
                hideLoading();
            }
        });

        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('searchButton').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
            updateSearchButton();
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
        }

        function hideError() {
            document.getElementById('error').classList.remove('active');
        }

        // æ˜¾ç¤ºæœç´¢åŒºåŸŸ
        function showSearchAreas(data, searchedLocations) {
            const panel = document.getElementById('searchAreasPanel');
            const hierarchyInfo = document.getElementById('hierarchyInfo');
            const locationTags = document.getElementById('locationTags');
            const lineTags = document.getElementById('lineTags');
            const locationSection = document.getElementById('locationSection');
            const lineSection = document.getElementById('lineSection');

            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            hierarchyInfo.innerHTML = '';
            locationTags.innerHTML = '';
            lineTags.innerHTML = '';

            // ä¼˜å…ˆä½¿ç”¨ searchedLocationsï¼ˆå®é™…æœç´¢çš„åœ°ç‚¹ï¼‰
            if (searchedLocations && searchedLocations.length > 0) {
                // æå–éƒ½é“åºœå¿ä¿¡æ¯
                const prefectures = [...new Set(searchedLocations.map(loc => loc.prefecture).filter(Boolean))];
                const cities = [...new Set(searchedLocations.map(loc => loc.city).filter(Boolean))];

                if (prefectures.length > 0) {
                    hierarchyInfo.innerHTML = `<span>${prefectures.join('ã€')}</span> â†’ <span>${cities.join('ã€')}</span>`;
                }

                locationSection.style.display = 'block';
                searchedLocations.forEach(loc => {
                    const tag = document.createElement('span');
                    tag.className = 'area-tag location';
                    const townInfo = loc.town ? ` ${loc.town}` : '';
                    tag.textContent = `${loc.city}${townInfo}`.trim();
                    locationTags.appendChild(tag);
                });

                lineSection.style.display = 'none';
                panel.classList.add('active');
                return;
            }

            // ä½¿ç”¨ searchOptions
            if (!data || !data.searchOptions || data.searchOptions.length === 0) {
                panel.classList.remove('active');
                return;
            }

            // æ˜¾ç¤ºå±‚æ¬¡ä¿¡æ¯
            if (data.hierarchyAnalysis) {
                const h = data.hierarchyAnalysis;
                hierarchyInfo.innerHTML = `
                    <span>${h.prefecture || ''}</span> â†’
                    <span>${h.mainCity || ''}</span>
                    ${h.nearbyDistricts && h.nearbyDistricts.length > 0 ?
                        ' ï¼ˆå‘¨è¾º: ' + h.nearbyDistricts.join('ã€') + 'ï¼‰' : ''}
                `;
            } else if (data.locations && data.locations.length > 0) {
                const loc = data.locations[0];
                hierarchyInfo.innerHTML = `<span>${loc.prefecture || ''}</span> â†’ <span>${loc.city || ''}</span>`;
            }

            // åˆ†ç±»æœç´¢é€‰é¡¹
            const locations = data.searchOptions.filter(opt => opt.searchMethod === 'location');
            const lines = data.searchOptions.filter(opt => opt.searchMethod === 'line');

            // æ˜¾ç¤ºæ‰€åœ¨åœ°
            if (locations.length > 0) {
                locationSection.style.display = 'block';
                locations.forEach(loc => {
                    const tag = document.createElement('span');
                    tag.className = 'area-tag location';
                    tag.textContent = `${loc.city} ${loc.town || ''}`.trim();
                    locationTags.appendChild(tag);
                });
            } else {
                locationSection.style.display = 'none';
            }

            // æ˜¾ç¤ºæ²¿çº¿
            if (lines.length > 0) {
                lineSection.style.display = 'block';
                lines.forEach(line => {
                    const tag = document.createElement('span');
                    tag.className = 'area-tag line';
                    tag.textContent = `${line.line} ${line.station}`;
                    lineTags.appendChild(tag);
                });
            } else {
                lineSection.style.display = 'none';
            }

            panel.classList.add('active');
        }

        // éšè—æœç´¢åŒºåŸŸ
        function hideSearchAreas() {
            document.getElementById('searchAreasPanel').classList.remove('active');
        }

        loadMBTITypes();
    </script>
</body>
</html>